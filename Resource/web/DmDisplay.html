<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="never">
    <title>弹幕显示</title>


    <style>
        @keyframes fadeIn {
            from {
                transform: translateY(10px);
                opacity: 0;
            }
            to {
                transform: translateY(0px);
                opacity: 1;
            }
        }

        .user {
            animation: fadeIn 0.5s ease-in-out;
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .avatar img {
            display: flex;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            border: 2px solid #fff;
        }


        .userName a {
            color: white;
            text-shadow: -1px -1px 0 #000000, 1px -1px 0 black, -1px 1px 0 black, 1px 1px 0 black;
            font-weight: bold;
            margin-right: 5px;
        }


        .Dm {
            margin-left: 5px;
            font-weight: bold;
            color: sienna;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .EmojiImg img {
            height: 40px;
        }


        .userName a {
            white-space: nowrap;
            vertical-align: top;
        }

        .fansMedal {
            display: flex;
        }

        .fansMedal div {
            font-size: 10px;
        }

        .fansMedalLevel {
            font-size: 10px;
            color: black;
            background: #ffffff;
            padding: 2px 5px;
            border-bottom-right-radius: 5px;
            border-top-right-radius: 5px;

            border-top: 1px solid #e3e3e3; /* 设置外部边框 */
            border-right: 1px solid #e3e3e3; /* 设置外部边框 */
            border-bottom: 1px solid #e3e3e3; /* 设置外部边框 */
        }

        .FansMedalText {
            color: #ffffff;
            padding: 2px 5px;
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;

            border-top: 1px solid #e3e3e3; /* 设置外部边框 */
            border-left: 1px solid #e3e3e3; /* 设置外部边框 */
            border-bottom: 1px solid #e3e3e3; /* 设置外部边框 */
        }


    </style>
</head>
<body>
<script src="/NoSleep.min.js"></script>
<div id="app">
    <div class="user">
        <div class="avatar">
            <img src="https://i2.hdslb.com/bfs/face/77c57a7b660b222460e738f639cdb600cb98ed4c.jpg">
        </div>

        <div class="UserInfoBox">
            <div class="fansMedal">
                <div class="FansMedalText">测试粉丝牌</div>
                <div class="fansMedalLevel">16</div>
            </div>
            <div class="userName">
                <a>普通用户</a>
                <a>:</a>
            </div>
        </div>


        <div class="Dm">
            <a>这是一条弹幕</a>
        </div>
        <div class="EmojiImg">
            <img src="http://i0.hdslb.com/bfs/emote/1e0cbe36d039b412f76fd72b3c86c0261a8aa521.png">
        </div>
    </div>
</div>
<script>
    const fansMedalColors = {
        1: "#5b958e",
        2: "#5b958e",
        3: "#5b958e",
        4: "#5b958e",
        5: "#5c7a9e",
        6: "#5c7a9e",
        7: "#5c7a9e",
        8: "#5c7a9e",
        9: "#8c7ba6",
        10: "#8c7ba6",
        11: "#8c7ba6",
        12: "#8c7ba6",
        13: "#bc6586",
        14: "#bc6586",
        15: "#bc6586",
        16: "#bc6586",
        17: "#c59c25",
        18: "#c59c25",
        19: "#c59c25",
        20: "#c59c25",
        21: "linear-gradient(to right, rgba(29, 86, 79, 1), rgba(29, 86, 79, 0))",
        22: "linear-gradient(to right, rgba(29, 86, 79, 1), rgba(29, 86, 79, 0))",
        23: "linear-gradient(to right, rgba(29, 86, 79, 1), rgba(29, 86, 79, 0))",
        24: "linear-gradient(to right, rgba(29, 86, 79, 1), rgba(29, 86, 79, 0))",
        25: "linear-gradient(to right, rgba(12, 28, 86, 1), rgba(12, 28, 86, 0))",
        26: "linear-gradient(to right, rgba(12, 28, 86, 1), rgba(12, 28, 86, 0))",
        27: "linear-gradient(to right, rgba(12, 28, 86, 1), rgba(12, 28, 86, 0))",
        28: "linear-gradient(to right, rgba(12, 28, 86, 1), rgba(12, 28, 86, 0))",
    };


    let Host = window.location.host

    Host = "127.0.0.1:100"

    function addUserStructure(FansMedalName, FansMedalLevel, AvatarURL, UserName, DmText, DmType) {
        // 创建父容器 <div class="user">
        const userDiv = document.createElement("div");
        userDiv.className = "user";

        //创建用户信息容器 <div class="UserInfoBox">
        const UserInfoBoxDiv = document.createElement("div");
        UserInfoBoxDiv.className = "UserInfoBox";


        //创建粉丝牌容器 <div class="fansMedal">
        const fansMedalDiv = document.createElement("div");
        fansMedalDiv.className = "fansMedal";

        //创建粉丝牌文字 <div class="FansMedalText">
        const FansMedalTextDiv = document.createElement("div");
        FansMedalTextDiv.className = "FansMedalText";
        FansMedalTextDiv.textContent = FansMedalName;
        FansMedalTextDiv.style.background = fansMedalColors[FansMedalLevel]

        //创建粉丝牌等级 <div class="fansMedalLevel">
        const fansMedalLevelDiv = document.createElement("div");
        fansMedalLevelDiv.className = "fansMedalLevel";
        fansMedalLevelDiv.textContent = FansMedalLevel;

        // 创建头像容器 <div class="avatar">
        const avatarDiv = document.createElement("div");
        avatarDiv.className = "avatar";

        // 创建头像图片 <img src="...">
        const avatarImg = document.createElement("img");
        avatarImg.src = AvatarURL;

        // 将头像图片添加到头像容器
        avatarDiv.appendChild(avatarImg);

        // 创建用户名容器 <div class="userName">
        const userNameDiv = document.createElement("div");
        userNameDiv.className = "userName";

        // 创建普通用户链接 <a>普通用户</a>
        const userLink = document.createElement("a");
        userLink.textContent = UserName;

        // 创建冒号元素 <a>:</a>
        const colonSpan = document.createElement("a");
        colonSpan.textContent = " :";

        // 将普通用户链接和冒号元素添加到用户名容器
        userNameDiv.appendChild(userLink);
        userNameDiv.appendChild(colonSpan);

        // 将头像容器、用户名容器和弹幕容器添加到父容器
        userDiv.appendChild(avatarDiv);

        UserInfoBoxDiv.appendChild(userNameDiv)

        if (FansMedalName !== "") {
            UserInfoBoxDiv.appendChild(fansMedalDiv)
        }
        userDiv.appendChild(UserInfoBoxDiv);


        if (DmType) {
            // 创建弹幕图片容器 <div class="EmojiImg">
            const EmojiImgDiv = document.createElement("div");
            EmojiImgDiv.className = "EmojiImg";

            // 创建弹幕图片 <img src="...">
            const EmojiImg = document.createElement("img");
            EmojiImg.src = DmText;

            // 将弹幕图片添加到弹幕图片容器
            EmojiImgDiv.appendChild(EmojiImg);

            // 将弹幕图片容器添加到父容器
            userDiv.appendChild(EmojiImgDiv);
        } else {
            // 创建弹幕容器 <div class="Dm">
            const dmDiv = document.createElement("div");
            dmDiv.className = "Dm";

            // 创建弹幕链接 <a>这是一条弹幕</a>
            const dmLink = document.createElement("a");
            dmLink.innerHTML = replaceEmoticons(DmText, emotionsMapping);
            // dmLink.textContent = DmText;

            // 将弹幕链接添加到弹幕容器
            dmDiv.appendChild(dmLink);

            userDiv.appendChild(dmDiv);
        }


        // 将父容器添加到适当位置
        const container = document.getElementById("app");
        container.appendChild(userDiv);

        window.scrollTo(0, document.body.scrollHeight);
    }

    function DelEarliestDm() {
        let DmList = document.getElementsByClassName("user")
        if (DmList.length > 50) {
            DmList[0].remove()
        }
    }

    setInterval(DelEarliestDm, 500)

    function replaceEmoticons(message, mappings) {
        // 创建正则表达式匹配所有[xxx]格式的表情文本
        const regex = /\[(.*?)\]/g;

        // 替换函数
        return message.replace(regex, (match) => {
            // 在映射表中查找对应的URL
            const url = mappings[match];
            // 如果找到则替换为<img>标签，否则保留原文本
            return url ? `<img src="${url}" style="vertical-align: middle; width: 24px; height: 24px;">` : match;
        });
    }

    const EmotionsTxt = `1 = [dog],http://i0.hdslb.com/bfs/live/4428c84e694fbf4e0ef6c06e958d9352c3582740.png
2 = [花],http://i0.hdslb.com/bfs/live/7dd2ef03e13998575e4d8a803c6e12909f94e72b.png
3 = [妙],http://i0.hdslb.com/bfs/live/08f735d950a0fba267dda140673c9ab2edf6410d.png
4 = [哇],http://i0.hdslb.com/bfs/live/650c3e22c06edcbca9756365754d38952fc019c3.png
5 = [爱],http://i0.hdslb.com/bfs/live/1daaa5d284dafaa16c51409447da851ff1ec557f.png
6 = [手机],http://i0.hdslb.com/bfs/live/b159f90431148a973824f596288e7ad6a8db014b.png
7 = [撇嘴],http://i0.hdslb.com/bfs/live/4255ce6ed5d15b60311728a803d03dd9a24366b2.png
8 = [委屈],http://i0.hdslb.com/bfs/live/69312e99a00d1db2de34ef2db9220c5686643a3f.png
9 = [抓狂],http://i0.hdslb.com/bfs/live/a7feb260bb5b15f97d7119b444fc698e82516b9f.png
10 = [比心],http://i0.hdslb.com/bfs/live/4e029593562283f00d39b99e0557878c4199c71d.png
11 = [赞],http://i0.hdslb.com/bfs/live/2dd666d3651bafe8683acf770b7f4163a5f49809.png
12 = [滑稽],http://i0.hdslb.com/bfs/live/8624fd172037573c8600b2597e3731ef0e5ea983.png
13 = [吃瓜],http://i0.hdslb.com/bfs/live/ffb53c252b085d042173379ac724694ce3196194.png
14 = [笑哭],http://i0.hdslb.com/bfs/live/c5436c6806c32b28d471bb23d42f0f8f164a187a.png
15 = [捂脸],http://i0.hdslb.com/bfs/live/e6073c6849f735ae6cb7af3a20ff7dcec962b4c5.png
16 = [喝彩],http://i0.hdslb.com/bfs/live/b51824125d09923a4ca064f0c0b49fc97d3fab79.png
17 = [偷笑],http://i0.hdslb.com/bfs/live/e2ba16f947a23179cdc00420b71cc1d627d8ae25.png
18 = [大笑],http://i0.hdslb.com/bfs/live/e2589d086df0db8a7b5ca2b1273c02d31d4433d4.png
19 = [惊喜],http://i0.hdslb.com/bfs/live/9c75761c5b6e1ff59b29577deb8e6ad996b86bd7.png
20 = [傲娇],http://i0.hdslb.com/bfs/live/b5b44f099059a1bafb2c2722cfe9a6f62c1dc531.png
21 = [疼],http://i0.hdslb.com/bfs/live/492b10d03545b7863919033db7d1ae3ef342df2f.png
22 = [吓],http://i0.hdslb.com/bfs/live/c6bed64ffb78c97c93a83fbd22f6fdf951400f31.png
23 = [阴险],http://i0.hdslb.com/bfs/live/a4df45c035b0ca0c58f162b5fb5058cf273d0d09.png
24 = [惊讶],http://i0.hdslb.com/bfs/live/bc26f29f62340091737c82109b8b91f32e6675ad.png
25 = [生病],http://i0.hdslb.com/bfs/live/84c92239591e5ece0f986c75a39050a5c61c803c.png
26 = [嘘],http://i0.hdslb.com/bfs/live/b6226219384befa5da1d437cb2ff4ba06c303844.png
27 = [奸笑],http://i0.hdslb.com/bfs/live/5935e6a4103d024955f749d428311f39e120a58a.png
28 = [囧],http://i0.hdslb.com/bfs/live/204413d3cf330e122230dcc99d29056f2a60e6f2.png
29 = [捂脸2],http://i0.hdslb.com/bfs/live/a2ad0cc7e390a303f6d243821479452d31902a5f.png
30 = [出窍],http://i0.hdslb.com/bfs/live/bb8e95fa54512ffea07023ea4f2abee4a163e7a0.png
31 = [吐了啊],http://i0.hdslb.com/bfs/live/2b6b4cc33be42c3257dc1f6ef3a39d666b6b4b1a.png
32 = [鼻子],http://i0.hdslb.com/bfs/live/f4ed20a70d0cb85a22c0c59c628aedfe30566b37.png
33 = [调皮],http://i0.hdslb.com/bfs/live/84fe12ecde5d3875e1090d83ac9027cb7d7fba9f.png
34 = [酸],http://i0.hdslb.com/bfs/live/98fd92c6115b0d305f544b209c78ec322e4bb4ff.png
35 = [冷],http://i0.hdslb.com/bfs/live/b804118a1bdb8f3bec67d9b108d5ade6e3aa93a9.png
36 = [OK],http://i0.hdslb.com/bfs/live/86268b09e35fbe4215815a28ef3cf25ec71c124f.png
37 = [微笑],http://i0.hdslb.com/bfs/live/f605dd8229fa0115e57d2f16cb019da28545452b.png
38 = [藏狐],http://i0.hdslb.com/bfs/live/05ef7849e7313e9c32887df922613a7c1ad27f12.png
39 = [龇牙],http://i0.hdslb.com/bfs/live/8b99266ea7b9e86cf9d25c3d1151d80c5ba5c9a1.png
40 = [防护],http://i0.hdslb.com/bfs/live/17435e60dcc28ce306762103a2a646046ff10b0a.png
41 = [笑],http://i0.hdslb.com/bfs/live/a91a27f83c38b5576f4cd08d4e11a2880de78918.png
42 = [一般],http://i0.hdslb.com/bfs/live/8d436de0c3701d87e4ca9c1be01c01b199ac198e.png
43 = [嫌弃],http://i0.hdslb.com/bfs/live/c409425ba1ad2c6534f0df7de350ba83a9c949e5.png
44 = [无语],http://i0.hdslb.com/bfs/live/4781a77be9c8f0d4658274eb4e3012c47a159f23.png
45 = [哈欠],http://i0.hdslb.com/bfs/live/6e496946725cd66e7ff1b53021bf1cc0fc240288.png
46 = [可怜],http://i0.hdslb.com/bfs/live/8e88e6a137463703e96d4f27629f878efa323456.png
47 = [歪嘴笑],http://i0.hdslb.com/bfs/live/bea1f0497888f3e9056d3ce14ba452885a485c02.png
48 = [亲亲],http://i0.hdslb.com/bfs/live/10662d9c0d6ddb3203ecf50e77788b959d4d1928.png
49 = [问号],http://i0.hdslb.com/bfs/live/a0c456b6d9e3187399327828a9783901323bfdb5.png
50 = [波吉],http://i0.hdslb.com/bfs/live/57dee478868ed9f1ce3cf25a36bc50bde489c404.png
51 = [OH],http://i0.hdslb.com/bfs/live/0d5123cddf389302df6f605087189fd10919dc3c.png
52 = [再见],http://i0.hdslb.com/bfs/live/f408e2af700adcc2baeca15510ef620bed8d4c43.png
53 = [白眼],http://i0.hdslb.com/bfs/live/7fa907ae85fa6327a0466e123aee1ac32d7c85f7.png
54 = [鼓掌],http://i0.hdslb.com/bfs/live/d581d0bc30c8f9712b46ec02303579840c72c42d.png
55 = [大哭],http://i0.hdslb.com/bfs/live/816402551e6ce30d08b37a917f76dea8851fe529.png
56 = [呆],http://i0.hdslb.com/bfs/live/179c7e2d232cd74f30b672e12fc728f8f62be9ec.png
57 = [流汗],http://i0.hdslb.com/bfs/live/b00e2e02904096377061ec5f93bf0dd3321f1964.png
58 = [生气],http://i0.hdslb.com/bfs/live/2c69dad2e5c0f72f01b92746bc9d148aee1993b2.png
59 = [加油],http://i0.hdslb.com/bfs/live/fbc3c8bc4152a65bbf4a9fd5a5d27710fbff2119.png
60 = [害羞],http://i0.hdslb.com/bfs/live/d8ce9b05c0e40cec61a15ba1979c8517edd270bf.png
61 = [虎年],http://i0.hdslb.com/bfs/live/a51af0d7d9e60ce24f139c468a3853f9ba9bb184.png
62 = [doge2],http://i0.hdslb.com/bfs/live/f547cc853cf43e70f1e39095d9b3b5ac1bf70a8d.png
63 = [金钱豹],http://i0.hdslb.com/bfs/live/b6e8131897a9a718ee280f2510bfa92f1d84429b.png
64 = [瓜子],http://i0.hdslb.com/bfs/live/fd35718ac5a278fd05fe5287ebd41de40a59259d.png
65 = [墨镜],http://i0.hdslb.com/bfs/live/5e01c237642c8b662a69e21b8e0fbe6e7dbc2aa1.png
66 = [难过],http://i0.hdslb.com/bfs/live/5776481e380648c0fb3d4ad6173475f69f1ce149.png
67 = [抱抱],http://i0.hdslb.com/bfs/live/abddb0b621b389fc8c2322b1cfcf122d8936ba91.png
68 = [跪了],http://i0.hdslb.com/bfs/live/4f2155b108047d60c1fa9dccdc4d7abba18379a0.png
69 = [摊手],http://i0.hdslb.com/bfs/live/1e0a2baf088a34d56e2cc226b2de36a5f8d6c926.png
70 = [热],http://i0.hdslb.com/bfs/live/6df760280b17a6cbac8c1874d357298f982ba4cf.png
71 = [三星堆],http://i0.hdslb.com/bfs/live/0a1ab3f0f2f2e29de35c702ac1ecfec7f90e325d.png
72 = [鼠],http://i0.hdslb.com/bfs/live/98f842994035505c728e32e32045d649e371ecd6.png
73 = [汤圆],http://i0.hdslb.com/bfs/live/23ae12d3a71b9d7a22c8773343969fcbb94b20d0.png
74 = [泼水],http://i0.hdslb.com/bfs/live/29533893115c4609a4af336f49060ea13173ca78.png
75 = [鬼魂],http://i0.hdslb.com/bfs/live/5d86d55ba9a2f99856b523d8311cf75cfdcccdbc.png
76 = [不行],http://i0.hdslb.com/bfs/live/607f74ccf5eec7d2b17d91b9bb36be61a5dd196b.png
77 = [响指],http://i0.hdslb.com/bfs/live/3b2fedf09b0ac79679b5a47f5eb3e8a38e702387.png
78 = [牛],http://i0.hdslb.com/bfs/live/5e61223561203c50340b4c9b41ba7e4b05e48ae2.png
79 = [保佑],http://i0.hdslb.com/bfs/live/241b13adb4933e38b7ea6f5204e0648725e76fbf.png
80 = [抱拳],http://i0.hdslb.com/bfs/live/3f170894dd08827ee293afcb5a3d2b60aecdb5b1.png
81 = [给力],http://i0.hdslb.com/bfs/live/d1ba5f4c54332a21ed2ca0dcecaedd2add587839.png
82 = [耶],http://i0.hdslb.com/bfs/live/eb2d84ba623e2335a48f73fb5bef87bcf53c1239.png`

 let emotionsMapping = convertTextToEmojiMappings(EmotionsTxt);



     function convertTextToEmojiMappings(text) {
         const lines = text.split('\n');
         const emojiMappings = {};

         lines.forEach(line => {
             const [key, value] = line.split(' = ');
             if (key && value) {
                 const [emoji, url] = value.split(',');
                 emojiMappings[emoji] = url;
             }
         });

         return emojiMappings;
     }
</script>
<script>

    function connect() {
        let DmSocket = new WebSocket(`ws://${Host}/DmWs`)

        DmSocket.onmessage = (event) => {

            //判断返回是否为Connected
            if (event.data === "Connected") {
                console.log("连接成功")
                return
            }

            let ReceiverDmDate = JSON.parse(event.data)
            if (!ReceiverDmDate.dm_type) {
                console.log("收到一条弹幕")
                addUserStructure(
                    ReceiverDmDate.fans_medal_name,
                    ReceiverDmDate.fans_medal_level,
                    ReceiverDmDate.uface,
                    ReceiverDmDate.uname,
                    ReceiverDmDate.msg,
                    ReceiverDmDate.dm_type)
                console.log(ReceiverDmDate.fans_medal_name, ReceiverDmDate.fans_medal_level, ReceiverDmDate.uface, ReceiverDmDate.uname, ReceiverDmDate.msg, ReceiverDmDate.dm_type)
            } else {
                console.log("收到一个表情包")
                addUserStructure(
                    ReceiverDmDate.fans_medal_name,
                    ReceiverDmDate.fans_medal_level,
                    ReceiverDmDate.uface,
                    ReceiverDmDate.uname,
                    ReceiverDmDate.emoji_img_url,
                    ReceiverDmDate.dm_type)
                console.log(ReceiverDmDate.fans_medal_name, ReceiverDmDate.fans_medal_level, ReceiverDmDate.uface, ReceiverDmDate.uname, ReceiverDmDate.emoji_img_url, ReceiverDmDate.dm_type)
            }

        }

        DmSocket.onclose = () => {
            console.log("连接断开，将在5秒后尝试重新连接")
            setTimeout(connect, 5000)
        }
    }

    connect()
    const noSleep = new NoSleep();

    function GetConfig() {
        const Http = new XMLHttpRequest();
        const Url = `http://${Host}/getConfig`;
        Http.open("GET", Url)
        Http.send()
        Http.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                let Config = JSON.parse(Http.responseText)
                if (Config.DmDisplayNoSleep) {
                    noSleep.enable();
                }
            }
        }
    }


    document.addEventListener('click', function enableNoSleep() {
        document.removeEventListener('click', enableNoSleep, false);
        prompt('点击确定以保持屏幕常亮');
        GetConfig()
    }, false);
</script>
</body>
</html>